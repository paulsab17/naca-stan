---
title: "NACA Stan fitting"
output: html_notebook
---

```{r libraries, echo=T, results='hide', message=F, warning=F}
library(rstan)
library(gdata)
library(bayesplot)
```


First thing to do is to set priors for parameters.
```{r priors}
prior_logkChemInt <- -3
priorSD_logkChemInt <- 0.5
prior_logkBleachInt <- -4
priorSD_logkBleachInt <- 0.5
prior_mChem <- -0.02
priorSD_mChem <- 0.5
prior_mBleach <- 0
priorSD_mBleach <- 0.5
prior_ext <- 0.02
priorSD_ext <- 0.01
prior_delay <- 2
priorSD_delay <- 0.01

init_params <- list(list(logkChemInt=prior_logkChemInt,
                    logkBleachInt=prior_logkBleachInt,
                    mChem=prior_mChem,
                    mBleach=prior_mBleach,
                    ext=prior_ext,
                    delay=prior_delay))
```

Next, specify experimental conditions. These are in units of micromolar:
```{r conditions}
initCys <- 50
initDTP <- 100
```

Later we will fit data and so will have meaningful values for these data values. For now, we are just simulating data from the priors, so we will just set them to junk data
```{r nullData}
N <- 2
time <- c(5,6)
gdn <- c(0,0)
absorbance <- c(0,0)
numTrials <- 1
trialStarts <- c(1,3)
```

After estimating parameters, the model will use them to simulate data at [Gdn] = 0, 3, and 6. This specifies how many data points to simulate for each.
```{r nData}
nDat_gen <- 25
```


Now we have to format all this data for stan.
```{r formatStanSim}
stan_data <-list(prior_logkChemInt=prior_logkChemInt, priorSD_logkChemInt=priorSD_logkChemInt, prior_logkBleachInt=prior_logkBleachInt, priorSD_logkBleachInt=priorSD_logkBleachInt, prior_mChem=prior_mChem, priorSD_mChem=priorSD_mChem, prior_mBleach=prior_mBleach, priorSD_mBleach=priorSD_mBleach, prior_ext=prior_ext,priorSD_ext=priorSD_ext, prior_delay=prior_delay, priorSD_delay=priorSD_delay, initCys=initCys, initDTP=initDTP, N=N, time=time, gdn=gdn, absorbance=absorbance, numTrials=numTrials, trialStarts=trialStarts,nDat_gen=nDat_gen)
```


Now we will simulate data from our priors using the stan file.
```{r stanSimulate}
stan_model<- "nacaModel.stan"
#stanc(file = stan_model, verbose = TRUE)
sim_data <- stan(file = stan_model,
             data = stan_data, init = init_params,
             chains = 1, iter = 1)
```


```{r}
posterior <- extract(sim_data)
str(posterior)
```

```{r}
pred_vals <- as.matrix(sim_data, pars = "pred_gdn_0")
times <- as.matrix(sim_data, pars = "times_gen")
pred_vals <- as.vector(pred_vals)
times <- as.vector(times)

pred_data <- data.frame("Time" = times,"Abs" = pred_vals)

ggplot(pred_data,aes(x = times, y = pred_vals)) +
  geom_point() +
  labs(x = "Time (s)", y = "Absorbance", title = "Predicted Values") +
  scale_x_continuous(trans='log10', labels = scales::label_number())

```

